<!DOCTYPE html>
<html lang="en">
<!-- This sample page assumes the uncompressed OZ HTML5 Viewer package is accessible and valid at http://127.0.0.1:8080/ozrviewer/. -->
<head>
    <title>RV HTML5</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>

<!--  Sample codes  -->
    <style>
        #wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 90vh; /* old browser fallback */
            height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #OZViewer {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="wrapper">
        <div id="OZViewer"></div>
    </div>
    <script type="text/javascript">
        const ozViewerId = "OZViewer";
        const ozViewer = document.getElementById(ozViewerId);

        const _g = new URLSearchParams(window.location.search);

        const ozViewerServer = (() => {
            const url = _g.get("svurl");
            if (url) {
                if (url == "origin") {
                    return location.origin + "/";
                }
                if (url.startsWith(location.protocol)) {
                    return decodeURIComponent(url.endsWith("/") ? url : url + "/");
                }
            }
            return "https://dev-test.oz4cs.com/";
        })();

        const ozViewerPath = (() => {
            const url = _g.get("rvurl");
            if (url && url.startsWith(location.protocol)) {
                return decodeURIComponent(url.endsWith("/") ? url : url + "/")
            }
            return ozViewerServer + "oz/HTML5/";
        })();

        const ozViewerStaticParams = {
            "information.debug": true,
            "global.inheritparameter": true,
            "viewer.progresscommand": true,
            "export.format": "pdf",
            "export.mode": "silent",
            "export.filename": "benchmark.pdf",
        };

        const ozViewerParams = {
            "connection.servlet": "MACRO_SVURL",
            "connection.reportname": "ozr_eForm/SignPad_1.ozr",
        };

        const ozViewerOpt = {
            "mstyle": (_g.get("mstyle") || "false") != "false",
            "save_exportfrom": (() => {
                const exportfrom = _g.get("exportfrom");
                switch (exportfrom) {
                    case "server":
                    case "scheduler":
                        return { "pdf": exportfrom };
                }
                return undefined;
            })(),
        };
    </script>

    <script type="text/javascript">
        (() => {
            const logFunc = console.log;
            console.log = (...args) => {
                logFunc("[VIEWER_PAGE]", ...args);
            };
        })();

        function loadAllLibs() {
            /**
             * @param {"js"|"css"} type
             * @param {string} url
             */
            function loadResource(type, url) {
                return new Promise((resolve, reject) => {
                    let element;

                    switch (type) {
                        case "js":
                            element = document.createElement('script');
                            element.src = url;
                            element.async = false;
                            break;
                        case "css":
                            element = document.createElement('link');
                            element.rel = 'stylesheet';
                            element.href = url;
                            break;
                        default:
                            reject(new Error(`Invalid resource type: ${type}`));
                            return;
                    }

                    element.onload = () => resolve(url);
                    element.onerror = () => reject(new Error(`Load failed: ${url}`));
                    document.head.appendChild(element);
                });
            }

            const loadingLibs = [
                "https://dev-test.oz4cs.com/oz/jquery/jquery-ui.css",
                ozViewerPath + "ui.dynatree.css",
            ].map(url => loadResource("css", url)).concat([
                "https://dev-test.oz4cs.com/oz/jquery/jquery.min.js",
                "https://dev-test.oz4cs.com/oz/jquery/jquery-ui.min.js",
                ozViewerPath + "jquery.dynatree.js",
                ozViewerPath + "OZJSViewer.js",
                ozViewerPath + "pdf_js/web/compatibility.js",
                ozViewerPath + "pdf_js/build/pdf.js",
            ].map(url => loadResource("js", url)));

            return Promise.all(loadingLibs).then(() => {    
                if (typeof PDFJS != "undefined") {
                    // cMapUrl must match the path of pdf.js file. If it is different from the default path, be sure to correct it.
                    PDFJS.cMapUrl = ozViewerPath + "pdf_js/web/cmaps/";
                    PDFJS.cMapPacked = true;
                }
            });
        }

        /**
         * @param {string} base64
         * @param {string} contentType
         */
        function makeBlobFromBase64(base64, contentType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: contentType });
        }

        /**
         * @param {"init"|"bind"|"export"|"finish"|"fail"} step
         */
        function postStopWatch(step, ref) {
            console.log("Post StopWatch", { step, time: new Date() });
            window.parent.postMessage({ type: "stopwatch", step, ref }, "*");
        }

        function OZUserActionCommand_OZViewer() {}
        function OZProgressCommand_OZViewer() {}
        function SetOZParamters_OZViewer() {}

        /**
         * @param {string} paramText
         * @param {string|undefined} sep
         **/
        function parameterListener(paramText, sep) {}

        window.addEventListener("message", event => {
            if (event.source == window) {
                return;
            }

            const { type, paramText, sep } = event.data;
            if (type != "parameters" || !paramText) {
                return;
            }
            parameterListener(paramText, sep)
        });

        loadAllLibs().then(() => new Promise(resolve => {
            postStopWatch("init");
            parameterListener = (paramText, sep = "\n") => {
                paramText.split(sep).forEach(line => {
                    const words = line.split("=");
                    if (words.length > 1) {
                        ozViewerParams[words[0]] = words.slice(1).join("=");
                    }
                });
                resolve();
            };
            postStopWatch("ready");
        })).then(() => new Promise(resolve => {
            postStopWatch("start");

            SetOZParamters_OZViewer = () => {
                [ozViewerParams, ozViewerStaticParams].forEach(params => {
                    Object.keys(params).forEach(paramKey => {
                        let paramValue = params[paramKey];
                        if (typeof paramValue == "object") {
                            paramValue = JSON.stringify(paramValue);
                        } else {
                            paramValue = "" + paramValue;
                        }
                        paramValue = paramValue
                            .replace(/MACRO_SVURL/g, ozViewerServer + "oz/server");
                        ozViewer.sendToActionScript(paramKey, paramValue);
                    });
                });
                return true;
            };

            const loading = [];
            const loaded = [];
            OZProgressCommand_OZViewer = (step, state, reportname) => {
                // console.log("PRG", { step, state, reportname });
                reportname = reportname.split(".")[0]; // reportname bug?
                const index = loading.indexOf(reportname);
                if (step == 4 && state == 2) {
                    if (index >= 0) {
                        loading.splice(index);
                    }
                    loaded.push(reportname);
                    console.log("Report Loaded:", reportname);
                    setTimeout(() => {
                        if (loading.length == 0) {
                            resolve(loaded.length);
                        }
                    });
                    return;
                }

                if (index < 0) {
                    loading.push(reportname);
                }
            };

            start_ozjs(ozViewerId, ozViewerPath, ozViewerOpt);
        })).then(count => {
            postStopWatch("bind", count);

            return new Promise((resolve, reject) => {
                OZExportMemoryStreamCallBack_OZViewer = jsonText => {
                    console.log("EXPORT", jsonText.slice(0, 30), `... (len=${jsonText.length})`);
                    resolve(jsonText);
                };
                ozViewer.Script("save_memorystream");
                setTimeout(() => {
                    reject(new Error("timeout 10s: save_memorystream"));
                }, 10000);
            });
        }).then(result => {
            postStopWatch("export", result);

            if ((_g.get("download") || "false") != "false") {
                const obj = JSON.parse(result);
                Object.keys(obj).forEach(k => {
                    const blob = makeBlobFromBase64(obj[k], "application/pdf");
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.download = k.endsWith(".pdf") ? k : k + ".pdf";
                    a.href = url;
                    a.style.position = "absolute";
                    a.style.opacity = "0";

                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    }, 1000);
                });
            
            }
            
        }).catch(e => {
            postStopWatch("fail", e);
            console.error(e);
        }).finally(() => {
            postStopWatch("finish");
        });
        
    </script>
</body>
</html>
